{% extends "base.html" %}
{% load static from staticfiles %}
{% block title %}Import File{% endblock %}
{% block css %}
    <link rel="stylesheet" media="screen"
          href="https://cdnjs.cloudflare.com/ajax/libs/handsontable/4.0.0/handsontable.min.css">

    <style>
    .identifier-area{
        outline: 1px solid lightgrey;
        height: 100px;
        width: 100%;
        padding: 5px;

    }

    .identifier-area:hover{
        {#background-color: #f2f2f2;#}
    }

    .identifier-selector{
        padding-right: 5px;
        padding-left: 5px;
        display: inline-block;
        color: black;
        border-radius: 20px;
        border: 2px solid #737373;
        margin-bottom: 3px;
        margin-left: 2px;
        {#outline : 1px solid black;#}
    }

    .identifier-selector:hover{
        cursor: grab;
        border: 2px solid lightseagreen;
        background-color: #f2f2f2;
    }
    </style>



{% endblock %}

{% block content %}

    <div class="row">
        <div class="col-sm-12" style="margin-bottom:40px">
            <h1 style="margin-bottom: 40px;"><i class="fas fa-shield-alt"></i> Preview and Risk Analysis</h1>
            <ul class="nav nav-pills">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="pill" href="#risk-tab">Risk Analysis</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="pill" href="#privacy-tab">Apply Privacy Models</a>
                </li>
            </ul>

            <div class="tab-content tab-space">
                <div class="tab-pane active" id="risk-tab">
                    <select id="attackermodel" style="margin-bottom:40px;margin-top:20px;">
                        <option value="prosecutor">Prosecutor Attacker Model</option>
                        <option value="journalist">Journalist Attacker Model</option>
                        <option value="marketer">Marketer Attacker Model</option>
                    </select>
                    <div class="row">
                        <div class="col-md-2">
                            <div id="g3"></div>
                        </div>
                        <div class="col-md-2">
                            <div id="g1"></div>
                        </div>
                        <div class="col-md-2">
                            <div id="g2"></div>
                        </div>
                    </div>
                    <b>Identifiers</b>
                    <div id="identifier-area-id"class="identifier-area" ondrop="drop(event)" ondragover="allowDrop(event)">
{#                        <div id="tomove" class="identifier-selector" draggable="true" ondragstart="drag(event)"> Name</div>#}
                    </div>
                    <b>Quasi Identifiers </b>
                    <div id="quasi-area-id" class="identifier-area" ondrop="drop(event)" ondragover="allowDrop(event)">

                    </div>
                    <b>Insensitive Data</b>
                    <div id="insensitive-area-id" class="identifier-area"ondrop="drop(event)" ondragover="allowDrop(event)">

                    </div>
{#                    <b>Sensitive Data</b>#}
{#                    <div>#}
{#                    </div>#}
                </div>

                <div class="tab-pane" id="privacy-tab">
                    <h3>Select Privacy Model to apply</h3>
                    <div style="margin-top:10px;">
                        <b>Privacy Model</b>
                    </div>
                    <select style="margin-bottom:40px;">
                        <option value="prosecutor" selected="selected">k-Anonymity</option>
                        <option value="journalist">k-Map</option>
                        <option value="marketer">Differential privacy</option>
                        <option value="marketer">Î´-Precense</option>
                    </select>
                    <div>
                        <b>Privacy Model Parameters</b>
                    </div>
                    <div style="margin-bottom:30px">
                        k-Parameter <input type="text" name="kparameter">
                    </div>
                    <div>
                        <b>Threshold Selection</b>
                        Acceptable highest probability of re-identification for a single record
                    </div>
                    <div>
                        Select a percent <input type="number" id="thresholdSelector" min="0" max="100" step="1"
                                                name="Threshold" value=20>
                    </div>
{#                    <div>#}
{#                        <b>Sample Extraction</b>#}
{#                        Percent of data to be considered research sample.#}
{#                        To consider the whole dataset as a research sample simply put percent as 100#}
{#                    </div>#}
{#                    <div style="margin-bottom:30px">#}
{#                        Select a percent <input type="number" id="sampleSelector" min="1" max="100" step="1"#}
{#                                                name="Threshold" value=100>#}
{#                    </div>#}
                    <a class="btn btn-warning" style="margin-bottom:20px" href="#"><i
                            class="fas fa-user-secret"></i> Apply Privacy Model</a>
                </div>
            </div>
        </div>
        <hr/>
        <div class="row">
            <div class="col-sm-12">
                <h3><i class="fas fa-seearch"></i>Preview of anonymised dataset</h3>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div onclick="downloadCSV()" class="btn btn-success" style="margin-bottom:20px"><i
                        class="fas fa-table"></i> Export to CSV</div>
                <div id="preview_table"></div>
            </div>
        </div>
    </div>

{% endblock %}

{% block js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handsontable/4.0.0/handsontable.min.js"></script>
    <script src="{% static 'vendor/justgage/justgage.js' %}"></script>
    <script src="{% static 'vendor/justgage/raphael-2.1.4.min.js' %}"></script>
    <script>
        //Placeolder variables for count meters
        var g1, g2, g3;
        //Varaibles where risk analysis results is stored
        var g1Prosecutor = 0, g1Journalist = 0, g2Prosecutor = 0, g2Journalist = 0, g3Prosecutor = 0, g3Journalist = 0,
            g3Marketer = 0;
        //Default values for threshold and starting samplePercent used
        var threshold = 0.2;
        var samplePercent = 100;
        var dataStatic =[];
        var identifiersStatic;

        var activeIdentifiersArray =[];
        var activeQuasiIdentifiersArray =[];
        var activeInsensitiveIdentifiersArray =[];

        window.onload = function () {
            g1 = new JustGage({
                id: "g1",
                value: 0,
                min: 0,
                max: 100,
                title: "Records at risk",
                label: "%"
            });
            g2 = new JustGage({
                id: "g2",
                value: 0,
                min: 0,
                max: 100,
                title: "Highest Risk",
                label: "%"
            });
            g3 = new JustGage({
                id: "g3",
                value: 0,
                min: 0,
                max: 100,
                title: "Success Rate",
                label: "%"
            });
            document.getElementById('attackermodel').addEventListener('change', function () {
                if (document.getElementById('attackermodel').value == "marketer") {
                    document.getElementById("g1").style.display = "none";
                    document.getElementById("g2").style.display = "none";
                    g1.refresh(0);
                    g2.refresh(0);
                    g3.refresh(g3Marketer);
                } else if (document.getElementById('attackermodel').value == "prosecutor") {
                    document.getElementById("g1").style.display = "block";
                    document.getElementById("g2").style.display = "block";
                    g1.refresh(g1Prosecutor);
                    g2.refresh(g2Prosecutor);
                    g3.refresh(g3Prosecutor);
                } else if (document.getElementById('attackermodel').value == "journalist") {
                    document.getElementById("g1").style.display = "block";
                    document.getElementById("g2").style.display = "block";
                    g1.refresh(g1Journalist);
                    g2.refresh(g2Journalist);
                    g3.refresh(g3Journalist);
                }

            });

            document.getElementById('thresholdSelector').addEventListener('change', function () {
                threshold = document.getElementById('thresholdSelector').value * 0.01;
                riskEvaluationRepeat(dataStatic, identifiersStatic,threshold, samplePercent);
            });

            document.getElementById('sampleSelector').addEventListener('change', function () {
                samplePercent = document.getElementById('sampleSelector').value;
                riskEvaluationRepeat(dataStatic, identifiersStatic,threshold, samplePercent);
            });
            // document.getElementById('attackermodel').addEventListener('change', function () {
            //     g1.refresh(getRandomInt(50, 100));
            //     g2.refresh(getRandomInt(50, 100));
            //     g3.refresh(getRandomInt(0, 50));
            // });

        }
    </script>
    <script src="{% static  'anonymizer/js/previewfilerisk.js' %}"></script>
    <script>
        $(function () {
            initTable({{ pk }});
            {#console.log(data);#}
        });


    </script>

    <script>
        //  url_string = window.location.href;
        //  var url = new URL(url_string);
        //  var pk = url.searchParams.get(pk);
        {#var data = {{ data|safe}};#}
        // var identifiers = data.shift();

        {#$.ajax({#}
        {#    type: "get",#}
        {#    url: "/anonymizer/connection/" + {{ pk }} +"/query/?q=all()",#}
        {#    data: {},#}
        {#    dataType: "json",#}
        {#    success: function (data) {#}
        {#        dataStatic = data;#}
        {#        riskEvaluation(data, threshold, samplePercent);#}
        {#    },#}
        {#    error: function (xhr, status, error) {#}
        {#        console.log(error)#}
        {#    }#}
        {# });#}

        /*
        * This function accepts the data
        * and copies them to avoid errors when re-calculating
        * when users change the risk threshold or
        * the percent of sample extracted.
        * */
        function riskEvaluation(olddata, oldidentifiers, threshold, samplePercent) {
            /* Copy the data because the original is still needed for later calls of the function*/
            var data = [];
            var olddataLength = olddata.length;
            for (var tempCounter = 0; tempCounter < olddataLength; tempCounter++) {
                data[tempCounter] = olddata[tempCounter].slice();
            }
            var identifiers= oldidentifiers.slice();


            /*
            * HIPAA based quasi identifiers and common namings of them
            * to be used for automatically selecting them
            * The name of the columns must be correct grammatically
            *The comparison is case insensitive
            * */
            var arrayOfNames = ["name", "surname", "alias", "nickname", "family name"];
            var arrayOfAdresses = ["address", "addresses", "home", "street", "zip code", "city", "county", "state", "country"];
            var arrayOfDates = ["date", "birth date", "death date", "discharge date", "admission date", "age"];
            var arrayOfPhones = ["phone", "cellphone"];
            var arrayOfFax = ["fax", "fax number"];
            var arrayOfEmail = ["email", "e-mail", "electronic mail"];
            var arrayOfBioIdentifiers = ["sex", "gender", "race", "marital"];

            var arrayOfQuasi =["longitudecustomer", "citypolizza" ,"latitudecustomer" , "provincepolizza" , "infortuniprecedenti" , "longitudepoliza" , "provincecustomer" , "sinistri" ,"descrizionerishio" , "blacklist" , "citycustomer" , "codicerischio" , "adresspolizza" ,"aia" , "gender" , "age" , "prodottto" , "ramo"];
            var arrayOfIdentifiers =["polizzaid" , "firstname" , "email" ,"lastname" , "mobile" , "addresscustomer" ];

            {#var generalArrayOfQuasi =["zip code", "city", "county", "state", "country", "sex", "gender", "race", "marital"];#}
            {#var generalArrayOfIdentifiers =["name", "surname", "alias", "nickname", "family name" ,"address", "addresses", "home", "street", "phone", "cellphone" ,"fax", "fax number" ,"email", "e-mail", "electronic mail"];#}

            var generalArrayOfQuasi =[];
            var generalArrayOfIdentifiers =[];

            var identifiersLength = identifiers.length;
            for (var tempCounter = 0; tempCounter < identifiersLength; tempCounter++) {
                {#if ((IdentifierCheck(identifiers[tempCounter], arrayOfNames) == 0) && (IdentifierCheck(identifiers[tempCounter], arrayOfAdresses) == 0) && (IdentifierCheck(identifiers[tempCounter], arrayOfDates) == 0) && (IdentifierCheck(identifiers[tempCounter], arrayOfPhones) == 0) && (IdentifierCheck(identifiers[tempCounter], arrayOfFax) == 0) && (IdentifierCheck(identifiers[tempCounter], arrayOfEmail) == 0) && (IdentifierCheck(identifiers[tempCounter], arrayOfBioIdentifiers) == 0)) {#}
                {#    identifiers.splice(tempCounter, 1);#}
                {#    for (var tempCounter1 = 0; tempCounter1 < data.length; tempCounter1++) {#}
                {#        data[tempCounter1].splice(tempCounter, 1);#}
                {#    }#}
                {#    tempCounter--;#}
                {#    identifiersLength = identifiers.length;#}
                {# }#}

                if ( (IdentifierCheck(identifiers[tempCounter] , arrayOfQuasi) == 0) && (IdentifierCheck(identifiers[tempCounter] , generalArrayOfQuasi) == 0) ) {
                    if((IdentifierCheck(identifiers[tempCounter] , arrayOfIdentifiers) == 0) && (IdentifierCheck(identifiers[tempCounter] , generalArrayOfIdentifiers) == 0) ){
                        //It means the column is insensitive data so we add it to the respective bucket
                        addIdentifierTag(2, identifiers[tempCounter]);
                        activeInsensitiveIdentifiersArray.push(identifiers[tempCounter]);
                    }else{
                        //It means the column is an identifier so we add it to the respective bucket
                        addIdentifierTag(0, identifiers[tempCounter]);
                        activeIdentifiersArray.push(identifiers[tempCounter]);
                    }

                    identifiers.splice(tempCounter, 1);
                    for (var tempCounter1 = 0; tempCounter1 < data.length; tempCounter1++) {
                        data[tempCounter1].splice(tempCounter, 1);
                    }
                    tempCounter--;
                    identifiersLength = identifiers.length;
                }else{
                    //It means the column is an quasi identifier so we add it to the respective bucket
                    activeQuasiIdentifiersArray.push(identifiers[tempCounter]);
                    addIdentifierTag(1, identifiers[tempCounter]);

                }
            }



            var sampleOffset = 0;
            var sampleFactor = 0.45;
            var sampleIgnoreOutliers = false;

            var popOffset = 0.45;
            var popFactor = 0.45;
            var popIgnoreOutliers = true;

            var sampleOnlyOffset = 0;
            var sampleOnlyFactor = 0.9;
            var sampleOnlyIgnoreOutliers = false;

            var prosecutorOffset = 0.9;
            var journalistOffset = 0.933;
            var marketerOffset = 0.966;

            var sample;
            var population;


            if (samplePercent == 100) {
                sample = getGroups(data, identifiers, sampleOnlyOffset, sampleOnlyFactor, 0, sampleOnlyIgnoreOutliers);
                population = sample;
            } else {
                var tempSampleSize = data.length * samplePercent / 100;

                data.splice(0, tempSampleSize);


                sample = getGroups(data, identifiers, sampleOffset, sampleFactor, 0, sampleIgnoreOutliers);
                population = getGroups(data, identifiers, popOffset, popFactor, 0, popIgnoreOutliers);
            }

            {#var tempc = 0#}
            {#for (var key in sample) {#}
            {#    delete sample[key];#}
            {#    if (tempc == 400) {#}
            {#        break;#}
            {#    }#}
            {#    tempc++;#}
            {# }#}

            getJournalistRisk(sample, population, journalistOffset, threshold);
            getMarketerRisk(sample, population, marketerOffset, threshold);
            getProsecutorRisk(sample, population, prosecutorOffset, threshold);
        }

        /*
        * This function accepts the data
        * and copies them to avoid errors when re-calculating
        * when users change the risk threshold or
        * the percent of sample extracted.
        * */
        function riskEvaluationRepeat(olddata, oldidentifiers, threshold, samplePercent) {
            /* Copy the data because the original is still needed for later calls of the function*/
            var data = [];
            var olddataLength = olddata.length;
            for (var tempCounter = 0; tempCounter < olddataLength; tempCounter++) {
                data[tempCounter] = olddata[tempCounter].slice();
            }
            var identifiers= oldidentifiers.slice();


            var identifiersLength = identifiers.length;
            for (var tempCounter = 0; tempCounter < identifiersLength; tempCounter++) {
                if ( IdentifierCheck(identifiers[tempCounter] , activeQuasiIdentifiersArray) == 0 ) {
                    identifiers.splice(tempCounter, 1);
                    for (var tempCounter1 = 0; tempCounter1 < data.length; tempCounter1++) {
                        data[tempCounter1].splice(tempCounter, 1);
                    }
                    tempCounter--;
                    identifiersLength = identifiers.length;
                }
            }



            var sampleOffset = 0;
            var sampleFactor = 0.45;
            var sampleIgnoreOutliers = false;

            var popOffset = 0.45;
            var popFactor = 0.45;
            var popIgnoreOutliers = true;

            var sampleOnlyOffset = 0;
            var sampleOnlyFactor = 0.9;
            var sampleOnlyIgnoreOutliers = false;

            var prosecutorOffset = 0.9;
            var journalistOffset = 0.933;
            var marketerOffset = 0.966;

            var sample;
            var population;


            if (samplePercent == 100) {
                sample = getGroups(data, identifiers, sampleOnlyOffset, sampleOnlyFactor, 0, sampleOnlyIgnoreOutliers);
                population = sample;
            } else {
                var tempSampleSize = data.length * samplePercent / 100;

                data.splice(0, tempSampleSize);


                sample = getGroups(data, identifiers, sampleOffset, sampleFactor, 0, sampleIgnoreOutliers);
                population = getGroups(data, identifiers, popOffset, popFactor, 0, popIgnoreOutliers);
            }

            {#var tempc = 0#}
            {#for (var key in sample) {#}
            {#    delete sample[key];#}
            {#    if (tempc == 400) {#}
            {#        break;#}
            {#    }#}
            {#    tempc++;#}
            {# }#}

            getJournalistRisk(sample, population, journalistOffset, threshold);
            getMarketerRisk(sample, population, marketerOffset, threshold);
            getProsecutorRisk(sample, population, prosecutorOffset, threshold);

            var opts = document.getElementById("attackermodel").options;

            for (var opt, j = 0; opt = opts[j]; j++) {
                if (opt.value == "prosecutor") {
                  document.getElementById("attackermodel").selectedIndex = j;
                  break;
                }
            }
        }


        // ignote outliers true if
        function getGroups(data, quasi, offset, factor, progress, ignoreoutliers) {
            // Getting data from database and number of quasi identifiers
            var map = {};
            var indices = [];
            for (var tempCounter = 0; tempCounter < quasi.length; tempCounter++) {

                var tempData = [];
                for (var tempCounter2 = 0; tempCounter2 < data.length; tempCounter2++) {
                    tempData.push(data[tempCounter2][tempCounter])
                }
                indices.push(tempData);
            }

            var capacity = data.length;
            if (capacity < 10) {
                capacity = 10;
            }
            var numRows = data.length;

            for (var row = 0; row < numRows; row++) {
                var prog = offset + row / numRows * factor;
                if (prog != progress) {
                    progress = prog;
                }

                var key = hashEntry(data[row]);

                if (!map.hasOwnProperty(key)) {
                    map[key] = 1;
                } else {
                    map[key] = map[key] + 1;
                }
            }

            console.log(map);
            return map
        }

        /*
        * This function produces a has from the row provided to it.
        * This moment the hashing is simply concating all the row parts
        * and using it as a key
        * */
        function hashEntry(row) {
            var temp = "";
            for (var it = 0; it < row.length; it++) {
                temp = temp.concat(row[it].toString());
            }

            return temp;

        }

        /*
        * This function computes the Risk of a prosecutor type of attack
        * */
        function getProsecutorRisk(sample, population, offset, threshold) {
            var progress = 0;
            var rA = 0;
            var rB = 0;
            var rC = 0;
            var numRecords = 0;
            var numClasses = 0;
            var smallestClassSize = Number.MAX_VALUE;
            var maxindex = Object.keys(sample).length;
            var index = 0;


            for (var prop in sample) {
                var elementSize = sample[prop];
                var prog = Math.round(offset + index / maxindex * 3.3);
                if (prog != progress) {
                    progress = prog
                }
                index = index + 1;

                // if element isn't supressed
                if (1) {
                    var groupSize = elementSize;

                    // Computing rA
                    if (1 / groupSize > threshold) {
                        rA += groupSize;
                    }

                    // Computing rB
                    if (groupSize < smallestClassSize) {
                        smallestClassSize = groupSize;
                    }

                    // Computing rC
                    numClasses++;
                    numRecords += groupSize;

                }

                if (stop) {

                }

            }

            rA = rA / numRecords;

            rB = 1 / smallestClassSize;

            rC = numClasses / numRecords;

            g1Prosecutor = rA * 100;
            g2Prosecutor = rB * 100;
            g3Prosecutor = rC * 100;

            g1.refresh(g1Prosecutor | 0);
            g2.refresh(g2Prosecutor | 0);
            g3.refresh(g3Prosecutor | 0);
        }

        /*
        * This function computes the Risk of a journalist type of attack
        * */
        function getJournalistRisk(sample, population, offset, threshold) {
            var progress = 0;
            var rA = 0;
            var rB = 0;
            var rC = 0;
            var rC1 = 0;
            var rC2 = 0;
            var numRecordsInSample = 0;
            var numClassesInSample = 0;
            var smallestClassSizeInPopulation = Number.MAX_VALUE;
            var maxindex = Object.keys(sample).length;
            var index = 0;


            for (var prop in sample) {
                var elementSize = sample[prop];
                var prog = Math.round(offset + index / maxindex * 3.3);
                if (prog != progress) {
                    progress = prog
                }
                index = index + 1;

                // if element isnt supressed
                if (1) {
                    var groupSizeInSample = elementSize;
                    var groupSizeInPopulation = groupSizeInSample;
                    if (population != sample) {
                        groupSizeInPopulation = Object.keys(population).length;
                    }

                    // Computing rA
                    if (1 / groupSizeInPopulation > threshold) {
                        rA += groupSizeInSample;
                    }

                    // Computing rB
                    if (groupSizeInPopulation < smallestClassSizeInPopulation) {
                        smallestClassSizeInPopulation = groupSizeInPopulation;
                    }

                    // Computing rC
                    numClassesInSample++;
                    numRecordsInSample += groupSizeInSample;
                    rC1 += groupSizeInPopulation;
                    rC2 += groupSizeInSample / groupSizeInPopulation;
                }

                if (stop) {

                }

            }

            rA = rA / numRecordsInSample;
            rB = 1 / smallestClassSizeInPopulation;

            rC1 = numClassesInSample / rC1;
            rC2 = rC2 / numRecordsInSample;
            rC = Math.max(rC1, rC2);

            g1Journalist = rA * 100;
            g2Journalist = rB * 100;
            g3Journalist = rC * 100;

            g1.refresh(g1Journalist | 0);
            g2.refresh(g2Journalist | 0);
            g3.refresh(g3Journalist | 0);

        }

        /*
        * This function computes the Risk of a marketer type of attack
        * */
        function getMarketerRisk(sample, population, offset, threshold) {
            var progress = 0;
            var rC = 0;
            var numRecordsInSample = 0;
            var maxindex = Object.keys(sample).length;
            var index = 0;

            for (var prop in sample) {
                var elementSize = sample[prop];
                var prog = Math.round(offset + index / maxindex * 3.3);
                if (prog != progress) {
                    progress = prog
                }
                index = index + 1;

                // if element isnt supressed
                if (1) {
                    var groupSizeInSample = elementSize;
                    var groupSizeInPopulation = groupSizeInSample;
                    if (population != sample) {
                        groupSizeInPopulation = Object.keys(population).length;
                    }

                    // Computing rC
                    numRecordsInSample += groupSizeInSample;
                    rC += groupSizeInSample / groupSizeInPopulation;
                }

                if (stop) {

                }

            }

            rC = rC / numRecordsInSample;

            g3Marketer = rC * 100;

            g3.refresh(g3Marketer | 0);

        }

        /*
        * This helper function is used to check if a identifier
        * actually belongs in an prefilled array of
        * common namings of quasi identifiers
        * Returns 1 if the identifiers belongs in this group 0 if not
        * */
        function IdentifierCheck(currentId, idList) {
            for (var tempCounter = 0; tempCounter < idList.length; tempCounter++) {
                if (currentId.toUpperCase() == idList[tempCounter].toUpperCase()) {
                    return 1;
                }
            }
            return 0;
        }

        /*
        * "0" - Identifiers area
        * "1" - Quasi Indentiiers area
        * "2" - Insensitive area
        * */
        function addIdentifierTag(id , title ) {
            var container = document.createElement("div");
            container.id="custom-tag" + title;
            container.classList.add("identifier-selector");
            container.setAttribute("draggable" , "true");
            container.setAttribute("ondragstart" , "drag(event)");
            container.innerHTML = title;
            if(id == 0){
                document.getElementById("identifier-area-id").appendChild(container);
                {#activeIdentifiersArray.push(title);#}
                {#var tempIndex = activeQuasiIdentifiersArray.indexOf(title);#}
                {#if(tempIndex > -1){#}
                {#    activeQuasiIdentifiersArray.splice(tempIndex,1);#}
                {# }#}
                {#tempIndex = activeInsensitiveIdentifiersArray.indexOf(title);#}
                {#if(tempIndex > -1){#}
                {#    activeQuasiIdentifiersArray.splice(tempIndex,1);#}
                {# }#}
            }else if(id == 1 ){
                document.getElementById("quasi-area-id").appendChild(container);
                {#activeQuasiIdentifiersArray.push(title);#}
                {#var tempIndex = activeIdentifiersArray.indexOf(title);#}
                {#if(tempIndex > -1){#}
                {#    activeIdentifiersArray.splice(tempIndex,1);#}
                {# }#}
                {#tempIndex = activeInsensitiveIdentifiersArray.indexOf(title);#}
                {#if(tempIndex > -1){#}
                {#    activeQuasiIdentifiersArray.splice(tempIndex,1);#}
                {# }#}

            }else if(id == 2){
                document.getElementById("insensitive-area-id").appendChild(container);
                {#activeInsensitiveIdentifiersArray.push(title);#}
                {#var tempIndex = activeQuasiIdentifiersArray.indexOf(title);#}
                {#if(tempIndex > -1){#}
                {#    activeQuasiIdentifiersArray.splice(tempIndex,1);#}
                {# }#}
                {#tempIndex = activeIdentifiersArray.indexOf(title);#}
                {#if(tempIndex > -1){#}
                {#    activeIdentifiersArray.splice(tempIndex,1);#}
                {# }#}
            }
        }
{#  <div id="tomove" class="identifier-selector" draggable="true" ondragstart="drag(event)"> Name</div>#}

        function arrayToCSV(response){
            var result, ctr, columnDelimiter, lineDelimiter;

            columnDelimiter = ",";
            lineDelimiter="\n";
            result ='';

            var tempDataLength = dataStatic.length;
            var tempIdLength = identifiersStatic.length;

            for (var tempIdCounter =0 ; tempIdCounter < tempIdLength;tempIdCounter++){
                result += identifiersStatic[tempIdCounter];
                if(tempIdCounter == (tempIdLength-1)) {
                    break;
                }
                result += columnDelimiter;
            }
            result += lineDelimiter;

            for(var tempDataCounter = 0 ; tempDataCounter < tempDataLength ;tempDataCounter++){
                ctr =0;
                for (var tempIdCounter =0 ; tempIdCounter < tempIdLength;tempIdCounter++){
                    if(ctr > 0){
                        result += columnDelimiter;
                    }
                    result += dataStatic[tempDataCounter][tempIdCounter];
                    ctr++;
                }
                result += lineDelimiter;
            }
            return result;
        }
        
        function downloadCSV() {
            var tempdata, filename, link;
            var stringCSV = arrayToCSV();
            if(stringCSV == null){
                return;
            }

            filename =  'anonnymisedDataset.csv';


            stringCSV = 'data:text/csv;charset=utf-8,' + stringCSV;
            tempdata = encodeURI(stringCSV);
            link = document.createElement('a');
            link.setAttribute('href',tempdata);
            link.setAttribute('download',filename);

            document.body.appendChild(link);
            link.click();

            return;
            {#alert("Data hasn't finished loading please wait and try again");#}
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev) {
            ev.preventDefault();
            var tomove = ev.dataTransfer.getData("text");
            ev.target.appendChild(document.getElementById(tomove));

            var targetArray;
            var otherArray1;
            var otherArray2;
            if(ev.currentTarget.id == "identifier-area-id"){
                targetArray = activeIdentifiersArray;
                otherArray1 = activeQuasiIdentifiersArray;
                otherArray2 = activeInsensitiveIdentifiersArray;
            }else if(ev.currentTarget.id == "quasi-area-id"){
                targetArray = activeQuasiIdentifiersArray;
                otherArray1 = activeIdentifiersArray;
                otherArray2 = activeInsensitiveIdentifiersArray;
            } else if(ev.currentTarget.id == "insensitive-area-id"){
                targetArray = activeInsensitiveIdentifiersArray;
                otherArray1 = activeQuasiIdentifiersArray;
                otherArray2 = activeIdentifiersArray;
            }

            var tempTitle = tomove.slice(10);
            targetArray.push(tempTitle);
            var tempIndex = otherArray1.indexOf(tempTitle);
            if(tempIndex > -1){
                otherArray1.splice(tempIndex,1);
            }
            tempIndex = otherArray2.indexOf(tempTitle);
            if(tempIndex > -1){
                otherArray2.splice(tempIndex,1);
            }

            riskEvaluationRepeat(dataStatic, identifiersStatic,threshold, samplePercent);
        }
    </script>
{% endblock %}